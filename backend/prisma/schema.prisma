generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  passwordHash          String                 @map("password_hash")
  name                  String
  company               String?
  plan                  UserPlan               @default(FREE)
  emailVerified         DateTime?              @map("email_verified")
  emailVerificationToken String?               @map("email_verification_token")
  emailVerificationCode String?                @map("email_verification_code")
  emailVerificationExpires DateTime?           @map("email_verification_expires")
  passwordResetToken    String?                @unique @map("password_reset_token")
  passwordResetExpires  DateTime?              @map("password_reset_expires")
  passwordResetCode     String?                @map("password_reset_code")
  passwordResetCodeExpires DateTime?           @map("password_reset_code_expires")
  image                 String?
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  budgets               Budget[]
  categories            Category[]
  clients               Client[]
  creditCards           CreditCard[]
  bankAccounts          BankAccount[]
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]
  scheduledReports      ScheduledReport[]

  @@index([email])
  @@index([plan])
  @@index([passwordResetToken])
  @@map("users")
}

model Transaction {
  id                     String                @id @default(cuid())
  userId                 String                @map("user_id")
  date                   DateTime
  month                  Int
  year                   Int
  type                   TransactionType
  categoryId             String                @map("category_id")
  clientId               String?               @map("client_id")
  description            String
  amountArs              Decimal               @map("amount_ars") @db.Decimal(15, 2)
  amountUsd              Decimal               @map("amount_usd") @db.Decimal(15, 2)
  exchangeRate           Decimal               @map("exchange_rate") @db.Decimal(10, 4)
  notes                  String?
  attachmentUrl          String?               @map("attachment_url")
  createdAt              DateTime              @default(now()) @map("created_at")
  updatedAt              DateTime              @updatedAt @map("updated_at")
  creditCardId           String?               @map("credit_card_id")
  paymentMethod          PaymentMethod?        @map("payment_method")
  bankAccountId          String?               @map("bank_account_id")
  isPaid                 Boolean               @default(true) @map("is_paid")
  recurringTransactionId String?               @map("recurring_transaction_id")
  category               Category              @relation(fields: [categoryId], references: [id])
  client                 Client?               @relation(fields: [clientId], references: [id])
  creditCard             CreditCard?           @relation(fields: [creditCardId], references: [id])
  bankAccount            BankAccount?          @relation(fields: [bankAccountId], references: [id])
  recurringTransaction   RecurringTransaction? @relation(fields: [recurringTransactionId], references: [id])
  user                   User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date(sort: Desc)])
  @@index([userId, type])
  @@index([userId, categoryId])
  @@index([userId, clientId])
  @@index([userId, year, month])
  @@index([userId, isPaid])
  @@index([creditCardId])
  @@index([bankAccountId])
  @@index([paymentMethod])
  @@map("transactions")
}

model Category {
  id                    String                 @id @default(cuid())
  userId                String                 @map("user_id")
  name                  String
  type                  TransactionType
  color                 String                 @default("#3b82f6")
  icon                  String                 @default("ðŸ’°")
  isDefault             Boolean                @default(false) @map("is_default")
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  budgets               Budget[]
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]

  @@unique([userId, name, type])
  @@index([userId, type])
  @@map("categories")
}

model Client {
  id                    String                 @id @default(cuid())
  userId                String                 @map("user_id")
  email                 String?
  phone                 String?
  company               String
  active                Boolean                @default(true)
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  responsible           String?                @db.VarChar(100)
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]

  @@unique([userId, company])
  @@index([userId, active])
  @@map("clients")
}

model Budget {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  categoryId String   @map("category_id")
  month      Int
  year       Int
  amountArs  Decimal  @map("amount_ars") @db.Decimal(15, 2)
  amountUsd  Decimal  @map("amount_usd") @db.Decimal(15, 2)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  category   Category @relation(fields: [categoryId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId, month, year])
  @@index([userId, year, month])
  @@map("budgets")
}

model ExchangeRate {
  id           String   @id @default(cuid())
  date         DateTime @unique
  currencyFrom String   @default("USD") @map("currency_from")
  currencyTo   String   @default("ARS") @map("currency_to")
  rate         Decimal  @db.Decimal(10, 4)
  source       String   @default("manual")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([date])
  @@index([currencyFrom, currencyTo, date])
  @@map("exchange_rates")
}

model RecurringTransaction {
  id           String              @id @default(cuid())
  userId       String              @map("user_id")
  type         TransactionType
  categoryId   String              @map("category_id")
  clientId     String?             @map("client_id")
  creditCardId String?             @map("credit_card_id")
  description  String
  amountArs    Decimal             @map("amount_ars") @db.Decimal(15, 2)
  amountUsd    Decimal             @map("amount_usd") @db.Decimal(15, 2)
  exchangeRate Decimal             @map("exchange_rate") @db.Decimal(10, 4)
  frequency    RecurrenceFrequency
  startDate    DateTime            @map("start_date")
  endDate      DateTime?           @map("end_date")
  dayOfMonth   Int?                @map("day_of_month")
  isActive     Boolean             @default(true) @map("is_active")
  notes        String?
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")
  category     Category            @relation(fields: [categoryId], references: [id])
  client       Client?             @relation(fields: [clientId], references: [id])
  creditCard   CreditCard?         @relation(fields: [creditCardId], references: [id])
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId, isActive])
  @@index([userId, frequency])
  @@map("recurring_transactions")
}

model CreditCard {
  id                    String                 @id @default(cuid())
  userId                String                 @map("user_id")
  name                  String
  lastFourDigits        String                 @map("last_four_digits")
  bank                  String?
  creditLimit           Decimal?               @map("credit_limit") @db.Decimal(15, 2)
  closingDay            Int                    @map("closing_day")
  dueDay                Int                    @map("due_day")
  isActive              Boolean                @default(true) @map("is_active")
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]

  @@unique([userId, lastFourDigits])
  @@index([userId, isActive])
  @@map("credit_cards")
}

model BankAccount {
  id            String           @id @default(cuid())
  userId        String           @map("user_id")
  name          String
  bank          String
  accountType   BankAccountType  @map("account_type")
  accountNumber String           @map("account_number")
  currency      Currency
  balance       Decimal?         @db.Decimal(15, 2)
  isActive      Boolean          @default(true) @map("is_active")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@unique([userId, accountNumber, bank])
  @@index([userId, isActive])
  @@index([userId, currency])
  @@map("bank_accounts")
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum UserPlan {
  FREE
  PRO
  ENTERPRISE
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum BankAccountType {
  SAVINGS
  CHECKING
  INVESTMENT
}

enum Currency {
  ARS
  USD
}

enum PaymentMethod {
  CASH
  MERCADOPAGO
  BANK_ACCOUNT
  CRYPTO
}

model ScheduledReport {
  id          String             @id @default(cuid())
  userId      String             @map("user_id")
  name        String
  type        ReportType
  frequency   ReportFrequency
  format      ReportFormat
  recipients  String[]           // Array de emails
  filters     Json?              // Filtros personalizados
  nextRun     DateTime           @map("next_run")
  lastRun     DateTime?          @map("last_run")
  isActive    Boolean            @default(true) @map("is_active")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([nextRun])
  @@map("scheduled_reports")
}

enum ReportType {
  MONTHLY
  ANNUAL
  CLIENT
  CATEGORY
  CUSTOM
}

enum ReportFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum ReportFormat {
  PDF
  EXCEL
  BOTH
}
